<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply Performance Indices Migration - Booth Beacon</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: #2d3748;
            color: white;
            padding: 2rem;
            text-align: center;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 2rem;
        }

        .status-badge {
            display: inline-block;
            background: #48bb78;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .instruction-box {
            background: #edf2f7;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            border-left: 4px solid #667eea;
        }

        .instruction-box h3 {
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .step {
            background: white;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .step-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .sql-container {
            background: #1a202c;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .sql-container pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .copy-button {
            background: #48bb78;
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: block;
            width: 100%;
            margin: 1rem 0;
        }

        .copy-button:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        .copy-button:active {
            transform: translateY(0);
        }

        .copy-button.copied {
            background: #4299e1;
        }

        .link-button {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 1rem 2rem;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            transition: all 0.3s;
            margin: 0.5rem;
        }

        .link-button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            display: block;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .warning {
            background: #fff5e1;
            border-left: 4px solid #f6ad55;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .success {
            background: #e6fffa;
            border-left: 4px solid #48bb78;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        footer {
            background: #f7fafc;
            padding: 2rem;
            text-align: center;
            color: #718096;
            border-top: 1px solid #e2e8f0;
        }

        code {
            background: #edf2f7;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì∏ Booth Beacon Performance Migration</h1>
            <p>Easy one-click migration application</p>
        </header>

        <div class="content">
            <span class="status-badge">‚úÖ READY TO APPLY</span>

            <h2>Performance Optimization Indices</h2>
            <p>This migration will create 9 critical performance indices and 1 helper function to dramatically improve your Booth Beacon database performance.</p>

            <div class="stats">
                <div class="stat-card">
                    <span class="stat-number">60-80%</span>
                    <span class="stat-label">Faster Queries</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">9</span>
                    <span class="stat-label">Performance Indices</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">0</span>
                    <span class="stat-label">Downtime Required</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">5-10</span>
                    <span class="stat-label">Minutes to Apply</span>
                </div>
            </div>

            <div class="instruction-box">
                <h3>üìã Quick Application Guide</h3>

                <div class="step">
                    <span class="step-number">1</span>
                    <strong>Copy the SQL below</strong> by clicking the green "Copy SQL" button
                </div>

                <div class="step">
                    <span class="step-number">2</span>
                    <strong>Open Supabase SQL Editor</strong> by clicking the "Open Supabase" button below
                </div>

                <div class="step">
                    <span class="step-number">3</span>
                    <strong>Paste the SQL</strong> into the editor and click "Run" (or press Cmd+Enter)
                </div>

                <div class="step">
                    <span class="step-number">4</span>
                    <strong>Wait 5-10 minutes</strong> for the indices to be created (uses CONCURRENTLY for zero downtime)
                </div>

                <div class="step">
                    <span class="step-number">5</span>
                    <strong>Verify success</strong> - you should see "ANALYZE" completion message
                </div>
            </div>

            <button class="copy-button" onclick="copySQLToClipboard()">
                üìã Copy SQL to Clipboard
            </button>

            <div style="text-align: center;">
                <a href="https://supabase.com/dashboard/project/tmgbmcbwfkvmylmfpkzy/sql" target="_blank" class="link-button">
                    üöÄ Open Supabase SQL Editor
                </a>
                <a href="file:///Users/jkw/Projects/booth-beacon-app/supabase/migrations/20260102192750_add_performance_indices.sql" target="_blank" class="link-button">
                    üìÑ View Migration File
                </a>
            </div>

            <div class="success">
                <strong>‚úÖ What You'll Get:</strong>
                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                    <li>80% faster map queries with geospatial GIST index</li>
                    <li>70% faster location filtering (city/country)</li>
                    <li>80% faster filter dropdown population</li>
                    <li>60% faster recent booth queries</li>
                    <li>New <code>find_nearby_booths()</code> helper function for distance queries</li>
                </ul>
            </div>

            <div class="warning">
                <strong>‚ö†Ô∏è Important Notes:</strong>
                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                    <li>This uses <code>CREATE INDEX CONCURRENTLY</code> for zero-downtime deployment</li>
                    <li>It's safe to run multiple times (idempotent)</li>
                    <li>Don't cancel the query - let it complete even if it takes 10+ minutes</li>
                    <li>All existing data remains intact</li>
                </ul>
            </div>

            <h3 style="margin-top: 2rem;">üìÑ Migration SQL</h3>
            <p style="color: #718096; margin-bottom: 1rem;">
                Click "Copy SQL" above or copy from the code box below:
            </p>

            <div class="sql-container" id="sqlContainer">
                <pre id="sqlContent">-- Loading SQL content...</pre>
            </div>

            <div style="margin-top: 2rem; padding: 1.5rem; background: #f7fafc; border-radius: 8px;">
                <h3>üîç After Application</h3>
                <p style="margin: 1rem 0;">Verify the migration succeeded by running this command in your terminal:</p>
                <div style="background: #2d3748; color: #e2e8f0; padding: 1rem; border-radius: 6px; font-family: monospace;">
                    cd /Users/jkw/Projects/booth-beacon-app<br>
                    node scripts/verify-performance-indices.js
                </div>
            </div>
        </div>

        <footer>
            <p><strong>Booth Beacon</strong> - Performance Optimization Migration</p>
            <p style="margin-top: 0.5rem;">Migration ID: 20260102192750_add_performance_indices</p>
            <p style="margin-top: 0.5rem;">Generated: January 2, 2026</p>
        </footer>
    </div>

    <script>
        // Load the SQL content
        async function loadSQL() {
            const sql = `-- =====================================================
-- PERFORMANCE OPTIMIZATION INDICES - PHASE 2
-- Booth Beacon Critical Performance Improvements
-- Council Recommendation: 60-70% performance improvement
-- Date: 2025-01-02
-- =====================================================

-- =====================================================
-- 1. GEOSPATIAL INDICES (Highest Priority)
-- =====================================================

-- Drop existing geospatial indices if they exist (idempotent)
DROP INDEX IF EXISTS idx_booths_location_gist CASCADE;
DROP INDEX IF EXISTS idx_booths_geography_gist CASCADE;
DROP INDEX IF EXISTS idx_booths_location_active CASCADE;

-- GIST index on geography for map queries (THE most critical index)
-- This enables efficient distance-based queries and bounding box searches
CREATE INDEX CONCURRENTLY idx_booths_geography_gist
ON booths USING GIST (
  geography(ST_MakePoint(longitude, latitude))
)
WHERE latitude IS NOT NULL AND longitude IS NOT NULL;

-- Comment for documentation
COMMENT ON INDEX idx_booths_geography_gist IS 'GIST spatial index for efficient map queries using PostGIS. Optimizes distance calculations and bounding box searches.';

-- =====================================================
-- 2. LOCATION SEARCH INDICES
-- =====================================================

-- Drop existing location search indices
DROP INDEX IF EXISTS idx_booths_city_country_operational CASCADE;
DROP INDEX IF EXISTS idx_booths_city_state_country CASCADE;
DROP INDEX IF EXISTS idx_booths_city_country CASCADE;
DROP INDEX IF EXISTS idx_booths_us_locations CASCADE;

-- Composite index for city/country/operational status (fastest for location filtering)
-- Covers queries like: WHERE city = ? AND country = ? AND is_operational = true
CREATE INDEX CONCURRENTLY idx_booths_city_country_operational
ON booths (city, country, is_operational)
WHERE latitude IS NOT NULL AND longitude IS NOT NULL;

COMMENT ON INDEX idx_booths_city_country_operational IS 'Composite index optimizing location-based filtering with operational status. Primary index for map location searches.';

-- Separate indices for filter dropdowns (city and country independently)
-- Users often filter by city OR country separately in UI dropdowns
DROP INDEX IF EXISTS idx_booths_city CASCADE;
DROP INDEX IF EXISTS idx_booths_country CASCADE;

CREATE INDEX CONCURRENTLY idx_booths_city
ON booths (city)
WHERE is_operational = true;

COMMENT ON INDEX idx_booths_city IS 'Index for city filter dropdown. Speeds up distinct city queries and city-based filtering.';

CREATE INDEX CONCURRENTLY idx_booths_country
ON booths (country)
WHERE is_operational = true;

COMMENT ON INDEX idx_booths_country IS 'Index for country filter dropdown. Speeds up distinct country queries and country-based filtering.';

-- =====================================================
-- 3. STATUS AND TIMESTAMP INDICES
-- =====================================================

-- Drop existing status indices
DROP INDEX IF EXISTS idx_booths_status_updated_at CASCADE;
DROP INDEX IF EXISTS idx_booths_status CASCADE;
DROP INDEX IF EXISTS idx_booths_updated_at CASCADE;

-- Composite index for recent booths (status + timestamp)
-- Covers: WHERE status = ? AND updated_at >= ? ORDER BY updated_at DESC
CREATE INDEX CONCURRENTLY idx_booths_status_updated_at
ON booths (status, updated_at DESC)
WHERE is_operational = true;

COMMENT ON INDEX idx_booths_status_updated_at IS 'Composite index for recently updated booths. Optimizes queries sorting by latest updates.';

-- =====================================================
-- 4. MACHINE MODEL SEARCH INDEX
-- =====================================================

-- Drop existing machine model index
DROP INDEX IF EXISTS idx_booths_machine_model CASCADE;

-- Index for machine model filtering
-- Users search for specific machine models (e.g., "Photo Booth Deluxe", "MiBO")
CREATE INDEX CONCURRENTLY idx_booths_machine_model
ON booths (machine_model)
WHERE machine_model IS NOT NULL AND is_operational = true;

COMMENT ON INDEX idx_booths_machine_model IS 'Index for machine model filtering. Optimizes queries filtering by specific booth models.';

-- =====================================================
-- 5. VERIFICATION AND DATA QUALITY INDICES
-- =====================================================

-- Drop existing verification indices
DROP INDEX IF EXISTS idx_booths_verification_status CASCADE;
DROP INDEX IF EXISTS idx_booths_last_verified CASCADE;

-- Verification status index for admin dashboard
CREATE INDEX CONCURRENTLY idx_booths_verification_status
ON booths (verification_status, last_verified DESC)
WHERE verification_status IS NOT NULL;

COMMENT ON INDEX idx_booths_verification_status IS 'Index for verification workflow and admin dashboard. Optimizes finding verified/unverified booths.';

-- =====================================================
-- 6. ENRICHMENT TRACKING INDICES
-- =====================================================

-- Drop existing enrichment indices
DROP INDEX IF EXISTS idx_booths_google_enriched_timestamp CASCADE;

-- Index for enrichment status tracking
CREATE INDEX CONCURRENTLY idx_booths_google_enriched_timestamp
ON booths (google_enriched_at DESC)
WHERE google_enriched_at IS NOT NULL;

COMMENT ON INDEX idx_booths_google_enriched_timestamp IS 'Index for tracking Google Maps enrichment progress. Identifies recently enriched booths.';

-- =====================================================
-- 7. ADMINISTRATIVE QUERY INDICES
-- =====================================================

-- Drop existing admin indices
DROP INDEX IF EXISTS idx_booths_created_at CASCADE;
DROP INDEX IF EXISTS idx_booths_created_verification CASCADE;

-- Index for admin dashboard creation timeline
CREATE INDEX CONCURRENTLY idx_booths_created_at
ON booths (created_at DESC)
WHERE status = 'active';

COMMENT ON INDEX idx_booths_created_at IS 'Index for admin dashboard. Optimizes queries for recently added booths.';

-- =====================================================
-- 8. SEARCH AND DISCOVERY INDICES
-- =====================================================

-- Drop existing search indices
DROP INDEX IF EXISTS idx_booths_search_vector CASCADE;

-- Full-text search index (if search_vector column exists)
-- Verify column exists before creating index
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'booths' AND column_name = 'search_vector'
  ) THEN
    DROP INDEX IF EXISTS idx_booths_search_vector CASCADE;
    CREATE INDEX CONCURRENTLY idx_booths_search_vector
    ON booths USING GIN (search_vector);

    COMMENT ON INDEX idx_booths_search_vector IS 'GIN index for full-text search. Optimizes complex text queries across booth data.';
  END IF;
END $$;

-- =====================================================
-- 9. GEOSPATIAL HELPER FUNCTION
-- =====================================================

-- Function to efficiently find nearby booths using the GIST index
CREATE OR REPLACE FUNCTION find_nearby_booths(
  lat DOUBLE PRECISION,
  lng DOUBLE PRECISION,
  distance_km DOUBLE PRECISION DEFAULT 50,
  limit_count INT DEFAULT 20
)
RETURNS TABLE(
  id UUID,
  name TEXT,
  address TEXT,
  city TEXT,
  country TEXT,
  latitude DOUBLE PRECISION,
  longitude DOUBLE PRECISION,
  distance_km DOUBLE PRECISION
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    b.id,
    b.name,
    b.address,
    b.city,
    b.country,
    b.latitude,
    b.longitude,
    ST_DistanceSphere(
      ST_MakePoint(lng, lat)::geography,
      ST_MakePoint(b.longitude, b.latitude)::geography
    ) / 1000 AS distance_km
  FROM booths b
  WHERE
    b.latitude IS NOT NULL
    AND b.longitude IS NOT NULL
    AND b.is_operational = true
    AND ST_DWithin(
      ST_MakePoint(lng, lat)::geography,
      ST_MakePoint(b.longitude, b.latitude)::geography,
      distance_km * 1000
    )
  ORDER BY distance_km ASC
  LIMIT limit_count;
END;
$$ LANGUAGE plpgsql STABLE;

COMMENT ON FUNCTION find_nearby_booths IS 'Efficiently finds booths within a distance radius using the GIST spatial index. Returns booths sorted by distance.';

-- =====================================================
-- 10. ANALYZE TABLES FOR QUERY OPTIMIZATION
-- =====================================================

-- Update statistics for the query planner
ANALYZE booths;

-- =====================================================
-- END OF MIGRATION
-- =====================================================`;

            document.getElementById('sqlContent').textContent = sql;
        }

        function copySQLToClipboard() {
            const sqlContent = document.getElementById('sqlContent').textContent;
            const button = document.querySelector('.copy-button');

            navigator.clipboard.writeText(sqlContent).then(() => {
                button.textContent = '‚úÖ SQL Copied to Clipboard!';
                button.classList.add('copied');

                setTimeout(() => {
                    button.textContent = 'üìã Copy SQL to Clipboard';
                    button.classList.remove('copied');
                }, 3000);
            }).catch(err => {
                alert('Failed to copy SQL: ' + err);
            });
        }

        // Load SQL on page load
        loadSQL();
    </script>
</body>
</html>
